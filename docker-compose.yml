# Local development environment
# Usage:
#   docker compose up          — start both server and web frontend
#   docker compose up server   — start only the API server (then run web:dev on host)
#
# The server hot-reloads on changes to src/ and server/ via nodemon.
# The web frontend hot-reloads via Vite.

services:
  server:
    image: mcr.microsoft.com/playwright:v1.58.1-noble
    working_dir: /app
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - ./data:/data
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      DB_PATH: /data/jobscout.sqlite
      PORT: "3000"
    command: >
      sh -c "npm install &&
             npx nodemon --watch server --watch src --ext ts,js --exec 'npx ts-node server/index.ts'"
    networks:
      - dev

  web:
    image: node:22-alpine
    working_dir: /app
    volumes:
      - ./web:/app
      - web_node_modules:/app/node_modules
    ports:
      - "5173:5173"
    environment:
      VITE_API_TARGET: http://server:3000
    command: sh -c "npm install && npm run dev"
    depends_on:
      - server
    networks:
      - dev

networks:
  dev:

volumes:
  node_modules:
  web_node_modules:
